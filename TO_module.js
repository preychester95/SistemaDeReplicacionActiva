var zmq = require('zmq');

var sequencedRequests = [];
var TOpoint = zmq.socket('router');
var handlerList = ['TO1']; //RELLENAR CUANDO CONOZCAMOS LOS IDS DE LOS HANDLERS
//var auxfunctions = require('./auxfunctions.js');

// ARGUMENTS
port = process.argv[2];

// Let clients connect to the router:
TOpoint.bindSync('tcp://127.0.0.1:' + port);

TOpoint.on('message', function(idHandler, request) {
	// Get the request generated by the client
	console.log('Recibido peticion de un manejador ' + idHandler);
	console.log('Recibida: '+request);
	var request = JSON.parse(request);

	var position = getPosition(request);
	if (position != -1) {
		console.log('La peticion ya tiene secuencia por lo que hacemos broadcast a todos los manejadores');
		broadCastToHandlers(sequencedRequests[position]);
	}
	else {
		console.log('La peticion NO tiene secuencia. La secuenciamos y hacemos broadcast a todos los manejadores');
		request.seq = sequencedRequests.length + 1;
		sequencedRequests.push(request);
		console.log('sequencedRequests: '+JSON.stringify(sequencedRequests[0]));
		broadCastToHandlers(request);
	}
});

function getPosition(request) {
	console.log('sequencedRequests en getPosition: '+JSON.stringify(sequencedRequests[0]));
	if (sequencedRequests.length <= 0 || sequencedRequests[0] == undefined)
		return -1;
	var i = 0;
	while ((i < sequencedRequests.length) && (sequencedRequests[i].idRequest != request.idRequest)) {
		i = i + 1;
	}
	if(i>=sequencedRequests.length){
		return -1;
	}
	else if (sequencedRequests[i].idRequest == request.idRequest) {
		return i;
	}

}

function broadCastToHandlers(request) {
	handlerList.forEach(function(handler) {
		console.log('Enviando a handler ' + handler);
		TOpoint.send([handler, JSON.stringify(request)]);
	}) 
}